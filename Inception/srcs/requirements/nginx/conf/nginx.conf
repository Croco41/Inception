# Default server configuration
# server	{
# 		listen 80;
# 		listen [::]:80;
# 		server_name iderighe.42.fr;
# 		return 301 https://$server_name$request_uri;
# }

# SSL configuration (SSL = Secure Socket Layer)
server	{
		server_name cgranja.42.fr;

		fastcgi_param HTTPS on;

		# Creation du canaux de communication entre Nginx & Internet (port 443 securise)
		listen 443 ssl;																				
		listen [::]:443 ssl;

		# Déclaration du Cerificat / Private Key / protocol utilisé
		# Self signed certs generated by the ssl-cert package. Don't use them in a production server!
		ssl_certificate /etc/ssl/certs/nginx.crt;
		ssl_certificate_key /etc/ssl/certs/nginx.key;
		ssl_protocols TLSv1.3;

		# Définition du dossier "root" de recherche (le meme dans le container wordpress)
		root /var/www/html/wordpress;

        # Définition des Index utilisés, pages erreurs en cas de problemes (index.php pour les erreurs wordpress)
		index index.html index.htm index.php;

		#requete client si / il faut qu'on le trqduise.
		location / {
				# Recherche récursive index.php depuis "root"
				# $uri = (Uniform Resource Identifier) dossier courrant de recherche
				# $args = trucs apres location
				try_files $uri $uri/ /index.php?$args;
				# C'est Wordpress qui enverra l'erreur 404 si besoin !
        }

		# Doc Module ngx_http_fastcgi_module |-> http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_split_path_info
	
		# fastcgi = Fast Common Gateway Interface
		#fastcgi va permettre la traduction vers php puis donc vers wordpress	
		location ~ \.php$ {
				fastcgi_split_path_info ^(.+\.php)(/.+)$;
				#	|-> defines a RegEx that captures a value for the variable #fastcgi_path_info, with two captures : the first
				# 		becomes the $fastcgi_script_name, the second becomes $fastcgi_path-info
				fastcgi_pass wordpress:9000;
				# 	|-> sets the adress of a FastCGI server. The address can be specified as a domain name or IP address AND a port
				fastcgi_index index.php;
				# 	|-> sets a file name that be appended after a URL ending with a slash, in the value of the $fastcgi_script_name variable
				#		example : URL = /page.php -> SCRIPT_FILENAME = .../page.php | URL = /page.php/ -> SCRIPT_FILENAME = .../index.php
				include fastcgi_params;
				# 	|-> pour pouvoir utiliser fastcgi_param ensuite
				fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
				fastcgi_param PATH_INFO $fastcgi_path_info;
				# try_files $uri $uri/ =404;
		}

		location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
				expires max;
				log_not_found off;
		}
}